<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Progress Dashboard ‚Äî Thor</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Custom styles -->
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 min-h-screen">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="bg-white dark:bg-neutral-800 border-b border-neutral-200 dark:border-neutral-700">
      <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">üìä Progress Dashboard</h1>
          <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">Track your performance trends</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="cfgPill" class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400">Connected</span>
        </div>
      </div>

      <!-- Tab Navigation -->
      <nav class="px-4 sm:px-6">
        <div class="flex gap-1 border-b border-neutral-200 dark:border-neutral-700">
          <a href="/index.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üè† Home
          </a>
          <a href="/nutrition.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üçé Nutrition
          </a>
          <a href="/running.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üèÉ Running
          </a>
          <a href="/health.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            ‚ù§Ô∏è Health
          </a>
          <a href="/history.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üìñ History
          </a>
          <span class="px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 dark:text-indigo-400">
            üìä Progress
          </span>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6">
      <!-- Time Range Selection -->
      <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>üìÖ</span> Time Range
        </h2>
        <div class="flex gap-2 flex-wrap">
          <button class="timeRange-btn px-4 py-2 rounded-lg border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors text-sm font-medium" data-days="7">Last 7 Days</button>
          <button class="timeRange-btn px-4 py-2 rounded-lg border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors text-sm font-medium active:bg-indigo-600 active:text-white" data-days="30">Last 30 Days</button>
          <button class="timeRange-btn px-4 py-2 rounded-lg border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors text-sm font-medium" data-days="90">Last 90 Days</button>
          <button class="timeRange-btn px-4 py-2 rounded-lg border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors text-sm font-medium" data-days="365">Last Year</button>
        </div>
      </div>

      <!-- Workouts Stats -->
      <section class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <div class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold">Total Workouts</div>
          <div class="text-3xl font-bold text-indigo-600 dark:text-indigo-400 mt-2" id="totalWorkouts">0</div>
        </div>
        <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <div class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold">Avg per Week</div>
          <div class="text-3xl font-bold text-emerald-600 dark:text-emerald-400 mt-2" id="avgWorkoutsPerWeek">0</div>
        </div>
        <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <div class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold">Total Running Distance</div>
          <div class="text-3xl font-bold text-orange-600 dark:text-orange-400 mt-2" id="totalDistance">0 km</div>
        </div>
        <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <div class="text-neutral-600 dark:text-neutral-400 text-sm font-semibold">Avg Running Pace</div>
          <div class="text-3xl font-bold text-blue-600 dark:text-blue-400 mt-2" id="avgPace">N/A</div>
        </div>
      </section>

      <!-- Charts Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Workout Frequency Chart -->
        <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span>üí™</span> Workout Frequency
          </h2>
          <canvas id="workoutChart" height="80"></canvas>
        </section>

        <!-- Running Distance Chart -->
        <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span>üèÉ</span> Running Distance Trend
          </h2>
          <canvas id="runningChart" height="80"></canvas>
        </section>
      </div>

      <!-- Health & Nutrition Stats -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Health Events -->
        <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span>‚ù§Ô∏è</span> Health Events Summary
          </h2>
          <div id="healthStats" class="space-y-2"></div>
        </section>

        <!-- Nutrition Summary -->
        <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
          <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
            <span>üçé</span> Nutrition Summary
          </h2>
          
          <!-- Nutrition Totals -->
          <div id="nutritionStats" class="grid grid-cols-2 gap-2 mb-6"></div>
          
          <!-- Nutrition Chart -->
          <div class="mt-4">
            <canvas id="nutritionChart" height="80"></canvas>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';
    let currentDays = 30;
    let workoutChart = null;
    let runningChart = null;

    // Initialize
    window.addEventListener('load', () => {
      document.querySelectorAll('.timeRange-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.timeRange-btn').forEach(b => {
            b.classList.remove('bg-indigo-600', 'text-white');
            b.classList.add('border-neutral-300', 'dark:border-neutral-700');
          });
          e.target.classList.add('bg-indigo-600', 'text-white');
          e.target.classList.remove('border-neutral-300', 'dark:border-neutral-700');
          currentDays = parseInt(e.target.dataset.days);
          loadProgressData();
        });
      });

      // Set 30 days as active by default
      document.querySelector('[data-days="30"]').classList.add('bg-indigo-600', 'text-white');
      loadProgressData();
    });

    async function loadProgressData() {
      const from = new Date();
      from.setDate(from.getDate() - currentDays);
      const to = new Date();

      const fromStr = from.toISOString().split('T')[0];
      const toStr = to.toISOString().split('T')[0];

      try {
        const [workoutsRes, runningRes, healthRes, nutritionRes] = await Promise.all([
          fetch(`${API_BASE}/api/workouts?from=${fromStr}&to=${toStr}`).then(r => r.json()).catch(() => ({ sessions: [] })),
          fetch(`${API_BASE}/api/running/sessions?from=${fromStr}&to=${toStr}`).then(r => r.json()).catch(() => ({ sessions: [] })),
          fetch(`${API_BASE}/api/health-events?from=${fromStr}&to=${toStr}`).then(r => r.json()).catch(() => ({ events: [] })),
          fetch(`${API_BASE}/api/nutrition/summary?from=${fromStr}&to=${toStr}&t=${Date.now()}`).then(r => r.json()).catch(() => ({}))
        ]);

        console.log('[Progress] Querying nutrition from', fromStr, 'to', toStr);
        console.log('[Progress] Nutrition API response:', nutritionRes);

        updateStats(workoutsRes.sessions || [], runningRes.sessions || [], healthRes.events || [], fromStr);
        updateCharts(workoutsRes.sessions || [], runningRes.sessions || [], fromStr, toStr);
        updateSummaries(healthRes.events || [], nutritionRes);
      } catch (error) {
        console.error('Error loading progress:', error);
      }
    }

    function updateStats(workouts, running, health, fromStr) {
      // Workout stats
      document.getElementById('totalWorkouts').textContent = workouts ? workouts.length : 0;
      
      // Calculate weeks in range
      const weeks = Math.ceil(currentDays / 7);
      const avgPerWeek = workouts ? Math.round((workouts.length / weeks) * 10) / 10 : 0;
      document.getElementById('avgWorkoutsPerWeek').textContent = avgPerWeek;

      // Running stats - convert miles to km
      const totalDistance = running ? running.reduce((sum, r) => sum + (parseFloat(r.distance_miles) || 0) * 1.60934, 0) : 0;
      document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';

      // Average pace
      if (running && running.length > 0) {
        const paces = running.map(r => r.pace_min_per_mile).filter(p => p);
        if (paces.length > 0) {
          document.getElementById('avgPace').textContent = paces[0]; // Show first pace as example
        }
      }
    }

    function updateCharts(workouts, running, fromStr, toStr) {
      // Aggregate data by week
      const weeks = generateWeekLabels(fromStr, toStr);
      const workoutsByWeek = aggregateByWeek(workouts, 'session_date', weeks);
      const distanceByWeek = aggregateByWeek(running, 'session_date', weeks, 'distance_miles');

      // Workout chart
      const workoutCtx = document.getElementById('workoutChart').getContext('2d');
      if (workoutChart) workoutChart.destroy();
      workoutChart = new Chart(workoutCtx, {
        type: 'line',
        data: {
          labels: weeks,
          datasets: [{
            label: 'Workouts per Week',
            data: workoutsByWeek,
            borderColor: 'rgb(99, 102, 241)',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { display: false } }
        }
      });

      // Running chart
      const runningCtx = document.getElementById('runningChart').getContext('2d');
      if (runningChart) runningChart.destroy();
      runningChart = new Chart(runningCtx, {
        type: 'line',
        data: {
          labels: weeks,
          datasets: [{
            label: 'Distance (km)',
            data: distanceByWeek,
            borderColor: 'rgb(249, 115, 22)',
            backgroundColor: 'rgba(249, 115, 22, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: { legend: { display: false } }
        }
      });
    }

    function updateSummaries(health, nutrition) {
      // Health summary
      const healthContainer = document.getElementById('healthStats');
      healthContainer.innerHTML = '';
      
      if (health && health.length > 0) {
        const categories = {};
        health.forEach(e => {
          categories[e.category] = (categories[e.category] || 0) + 1;
        });
        
        Object.entries(categories).forEach(([cat, count]) => {
          const div = document.createElement('div');
          div.className = 'flex justify-between items-center p-2 rounded bg-neutral-50 dark:bg-neutral-900';
          div.innerHTML = `<span class="text-sm">${cat}</span><span class="font-medium text-indigo-600 dark:text-indigo-400">${count}</span>`;
          healthContainer.appendChild(div);
        });
      } else {
        healthContainer.innerHTML = '<p class="text-sm text-neutral-600 dark:text-neutral-400">No health events recorded</p>';
      }

      // Nutrition summary - display totals, not individual foods
      const nutritionContainer = document.getElementById('nutritionStats');
      nutritionContainer.innerHTML = '';
      
      if (nutrition && nutrition.totals) {
        const { total_calories_kcal, total_protein_g, total_sodium_mg, total_sat_fat_g, total_fiber_g, days_logged } = nutrition.totals;
        const items = [
          { value: `${Math.round(total_calories_kcal)} kcal`, icon: 'üî•', title: 'Calories' },
          { value: `${Math.round(total_protein_g)}g`, icon: 'ü•ö', title: 'Protein' },
          { value: `${Math.round(total_fiber_g)}g`, icon: 'üåæ', title: 'Fiber' },
          { value: `${Math.round(total_sodium_mg)}mg`, icon: 'üßÇ', title: 'Sodium' },
          { value: days_logged, icon: 'üìÖ', title: 'Days' }
        ];
        
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'flex flex-col items-center p-3 rounded bg-neutral-50 dark:bg-neutral-900';
          div.title = item.title;
          div.innerHTML = `<span class="text-2xl mb-1">${item.icon}</span><span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">${item.value}</span>`;
          nutritionContainer.appendChild(div);
        });
        
        // Create nutrition chart
        console.log('[Progress] Daily data for chart:', nutrition.daily);
        renderNutritionChart(nutrition.daily);
      } else {
        nutritionContainer.innerHTML = '<p class="text-sm text-neutral-600 dark:text-neutral-400 col-span-2">No nutrition data recorded</p>';
      }
    }

    function generateWeekLabels(fromStr, toStr) {
      const from = new Date(fromStr);
      const to = new Date(toStr);
      const weeks = [];
      const weekData = [];
      
      let current = new Date(from);
      // Align to start of week (Sunday)
      current.setDate(current.getDate() - current.getDay());
      
      while (current <= to) {
        const weekStart = new Date(current);
        const weekLabel = `${weekStart.getDate()} ${weekStart.toLocaleString('default', { month: 'short' })}`;
        weeks.push(weekLabel);
        weekData.push({ start: new Date(weekStart), end: new Date(weekStart.getTime() + 7 * 24 * 60 * 60 * 1000) });
        current.setDate(current.getDate() + 7);
      }
      
      // Store weekData globally for use in aggregateByWeek
      window.weekRanges = weekData;
      return weeks;
    }

    function aggregateByWeek(items, dateField, weeks, valueField = null) {
      return weeks.map((week, idx) => {
        if (!window.weekRanges || !window.weekRanges[idx]) return 0;
        
        const { start: weekStart, end: weekEnd } = window.weekRanges[idx];

        return items ? items.filter(item => {
          const itemDate = new Date(item[dateField]);
          return itemDate >= weekStart && itemDate < weekEnd;
        }).reduce((sum, item) => {
          if (valueField) return sum + (parseFloat(item[valueField]) || 0);
          return sum + 1;
        }, 0) : 0;
      });
    }

    function renderNutritionChart(dailyData) {
      const ctx = document.getElementById('nutritionChart');
      if (!ctx) {
        console.error('[Progress] nutritionChart canvas not found');
        return;
      }

      // Destroy existing chart if it exists
      if (window.nutritionChart) {
        window.nutritionChart.destroy();
      }

      if (!dailyData || dailyData.length === 0) {
        console.warn('[Progress] No daily data to chart');
        return;
      }

      // Filter and prepare data
      const data = dailyData.filter(d => d.date_local).map(d => ({
        date: d.date_local,
        calories: d.calories_kcal || 0,
        protein: d.protein_g || 0,
        fiber: d.fiber_g || 0,
        sodium: (d.sodium_mg || 0) / 10 // Scale down sodium for visibility
      }));

      console.log('[Progress] Chart data prepared:', data);

      const labels = data.map(d => {
        const date = new Date(d.date);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      });

      window.nutritionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Calories (kcal)',
              data: data.map(d => d.calories),
              backgroundColor: '#ef4444',
              borderColor: '#dc2626',
              borderWidth: 1
            },
            {
              label: 'Protein (g)',
              data: data.map(d => d.protein),
              backgroundColor: '#f97316',
              borderColor: '#ea580c',
              borderWidth: 1
            },
            {
              label: 'Fiber (g)',
              data: data.map(d => d.fiber),
              backgroundColor: '#22c55e',
              borderColor: '#16a34a',
              borderWidth: 1
            },
            {
              label: 'Sodium (mg √∑10)',
              data: data.map(d => d.sodium),
              backgroundColor: '#06b6d4',
              borderColor: '#0891b2',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#a3a3a3' : '#404040',
                font: { size: 12 },
                padding: 12
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              grid: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#404040' : '#e5e5e5'
              },
              ticks: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#a3a3a3' : '#666'
              }
            },
            y: {
              stacked: false,
              beginAtZero: true,
              grid: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#404040' : '#e5e5e5'
              },
              ticks: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#a3a3a3' : '#666'
              }
            }
          }
        }
      });
      console.log('[Progress] Chart created successfully');
    }
  </script>
</body>
</html>
