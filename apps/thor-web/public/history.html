<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>History Dashboard ‚Äî Thor</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Custom styles -->
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 min-h-screen">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="bg-white dark:bg-neutral-800 border-b border-neutral-200 dark:border-neutral-700">
      <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">üìñ History Dashboard</h1>
          <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">View your complete activity log</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="cfgPill" class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400">Connected</span>
        </div>
      </div>

      <!-- Tab Navigation -->
      <nav class="px-4 sm:px-6">
        <div class="flex gap-1 border-b border-neutral-200 dark:border-neutral-700">
          <a href="/index.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üè† Home
          </a>
          <a href="/nutrition.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üçé Nutrition
          </a>
          <a href="/running.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üèÉ Running
          </a>
          <a href="/health.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            ‚ù§Ô∏è Health
          </a>
          <span class="px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 dark:text-indigo-400">
            üìñ History
          </span>
          <a href="/progress.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            üìä Progress
          </a>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6">
      <!-- Date Range Filter -->
      <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>üóìÔ∏è</span> Filter by Date Range
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">From</label>
            <input type="date" id="dateFrom" class="w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">To</label>
            <input type="date" id="dateTo" class="w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div class="flex items-end gap-2">
            <button id="filterBtn" class="flex-1 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 font-medium text-sm transition-colors">
              Filter
            </button>
            <button id="clearFilterBtn" class="rounded-lg border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors px-4 py-2.5 text-sm font-medium">
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Events by Date -->
      <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>üìÖ</span> All Events
        </h2>
        <div id="eventsByDate" class="space-y-6"></div>
        <div id="noEvents" class="text-sm text-neutral-600 dark:text-neutral-400 text-center py-4">No events found</div>
      </section>

      <!-- Nutrition Summary for Date Range -->
      <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 mt-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>üçé</span> Nutrition Summary
        </h2>
        
        <!-- Nutrition Totals -->
        <div id="nutritionSummary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <p class="text-sm text-neutral-600 dark:text-neutral-400">Loading nutrition data...</p>
        </div>
        
        <!-- Nutrition Chart -->
        <div class="mt-4" style="position: relative; height: 300px;">
          <canvas id="nutritionChartHistory"></canvas>
        </div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';

    // Initialize date inputs to last 30 days
    window.addEventListener('load', () => {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;
      document.getElementById('dateTo').valueAsDate = today;
      
      loadHistoryData();
    });

    document.getElementById('filterBtn').addEventListener('click', loadHistoryData);
    document.getElementById('clearFilterBtn').addEventListener('click', () => {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;
      document.getElementById('dateTo').valueAsDate = today;
      loadHistoryData();
    });

    async function loadHistoryData() {
      const from = document.getElementById('dateFrom').value;
      const to = document.getElementById('dateTo').value;

      try {
        // Load all data in parallel
        const [workoutsRes, runningRes, healthRes, nutritionRes] = await Promise.all([
          fetch(`${API_BASE}/api/workouts?from=${from}&to=${to}`).then(r => r.json()).catch(() => ({ sessions: [] })),
          fetch(`${API_BASE}/api/running/sessions?from=${from}&to=${to}`).then(r => r.json()).catch(() => ({ sessions: [] })),
          fetch(`${API_BASE}/api/health-events?from=${from}&to=${to}`).then(r => r.json()).catch(() => ({ events: [] })),
          fetch(`${API_BASE}/api/nutrition/summary?from=${from}&to=${to}&t=${Date.now()}`).then(r => r.json()).catch(() => ({}))
        ]);

        // Fetch detailed exercises for each workout
        const workoutSessions = workoutsRes.sessions || [];
        const workoutsWithDetails = await Promise.all(
          workoutSessions.map(async (session) => {
            const detailRes = await fetch(`${API_BASE}/api/workouts?date=${session.session_date}`)
              .then(r => r.json())
              .catch(() => ({ workouts: [] }));
            const details = detailRes.workouts || [];
            return { ...session, exercises: details.length > 0 ? details[0].exercises : [] };
          })
        );

        displayEventsByDate(
          workoutsWithDetails,
          runningRes.sessions || [],
          healthRes.events || []
        );
        displayNutritionSummary(nutritionRes);
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    async function loadDailySummary(date, container) {
      try {
        const response = await fetch(`http://localhost:3000/api/daily-summary/${date}`);
        
        if (!response.ok) {
          container.innerHTML = '<p class="text-neutral-600 dark:text-neutral-400 italic">No summary yet. Generate one with the ‚ú® Summary button above.</p>';
          return;
        }
        
        const data = await response.json();
        
        if (!data.sections) {
          container.innerHTML = '<p class="text-neutral-600 dark:text-neutral-400 italic">No summary data available.</p>';
          return;
        }
        
        const sections = data.sections;
        
        // Build sections HTML
        let html = '';
        
        // Your Day (Goggins Mode) at the top
        if (sections.yourDay) {
          html += `
            <div class="mb-4 p-3 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 border-l-4 border-orange-600 dark:border-orange-400 rounded">
              <h5 class="font-semibold text-orange-900 dark:text-orange-100 mb-2">üí™ Your Day (Goggins Mode)</h5>
              <div class="text-xs text-orange-800 dark:text-orange-200 italic">${convertMarkdownToHTML(sections.yourDay)}</div>
            </div>
          `;
        }
        
        if (sections.highlights && sections.highlights.length > 0) {
          html += `
            <div class="mb-4">
              <h5 class="font-semibold text-indigo-900 dark:text-indigo-100 mb-2">‚ú® Highlights</h5>
              <div class="text-xs text-indigo-800 dark:text-indigo-200">${convertMarkdownToHTML(sections.highlights.join('\n'))}</div>
            </div>
          `;
        }
        
        if (sections.dashHeartHealthy) {
          html += `
            <div>
              <h5 class="font-semibold text-indigo-900 dark:text-indigo-100 mb-2">‚ù§Ô∏è DASH & Heart-Healthy</h5>
              <div class="text-xs text-indigo-800 dark:text-indigo-200">${convertMarkdownToHTML(sections.dashHeartHealthy)}</div>
            </div>
          `;
        }
        
        if (sections.proteinRecovery) {
          html += `
            <div>
              <h5 class="font-semibold text-indigo-900 dark:text-indigo-100 mb-2">üí™ Protein & Recovery</h5>
              <div class="text-xs text-indigo-800 dark:text-indigo-200">${convertMarkdownToHTML(sections.proteinRecovery)}</div>
            </div>
          `;
        }
        
        if (sections.training) {
          html += `
            <div>
              <h5 class="font-semibold text-indigo-900 dark:text-indigo-100 mb-2">üèãÔ∏è Training Review</h5>
              <div class="text-xs text-indigo-800 dark:text-indigo-200">${convertMarkdownToHTML(sections.training)}</div>
            </div>
          `;
        }
        
        if (sections.redFlags) {
          html += `
            <div>
              <h5 class="font-semibold text-red-900 dark:text-red-100 mb-2">‚ö†Ô∏è Red Flags</h5>
              <div class="text-xs text-red-800 dark:text-red-200">${convertMarkdownToHTML(sections.redFlags)}</div>
            </div>
          `;
        }
        
        if (sections.tomorrowPriorities) {
          html += `
            <div>
              <h5 class="font-semibold text-amber-900 dark:text-amber-100 mb-2">üìã Tomorrow's Priorities</h5>
              <div class="text-xs text-amber-800 dark:text-amber-200">${convertMarkdownToHTML(sections.tomorrowPriorities)}</div>
            </div>
          `;
        }
        
        container.innerHTML = html;
      } catch (error) {
        console.error('[History] Error loading summary:', error);
        container.innerHTML = '<p class="text-neutral-600 dark:text-neutral-400 italic">Error loading summary.</p>';
      }
    }

    function convertMarkdownToHTML(markdown) {
      if (!markdown) return '';
      
      let html = markdown;
      
      // Bold: **text** ‚Üí <strong>text</strong>
      html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      // Italic: *text* ‚Üí <em>text</em> (but not inside bold)
      html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
      
      // Handle line breaks and lists
      const lines = html.split('\n');
      let result = [];
      let inList = false;
      let listType = null; // 'unordered' or 'ordered'
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        
        if (line === '') {
          // Empty line - close list if open
          if (inList) {
            result.push(listType === 'ordered' ? '</ol>' : '</ul>');
            inList = false;
            listType = null;
          }
          continue;
        }
        
        // Check for unordered list items (- or *)
        if (line.match(/^[-*]\s+/)) {
          if (!inList || listType !== 'unordered') {
            if (inList) result.push(listType === 'ordered' ? '</ol>' : '</ul>');
            result.push('<ul class="list-disc list-inside mt-1 space-y-0.5">');
            inList = true;
            listType = 'unordered';
          }
          const content = line.replace(/^[-*]\s+/, '');
          result.push(`<li>${content}</li>`);
        }
        // Check for ordered list items (1., 2., etc.)
        else if (line.match(/^\d+\.\s+/)) {
          if (!inList || listType !== 'ordered') {
            if (inList) result.push(listType === 'ordered' ? '</ol>' : '</ul>');
            result.push('<ol class="list-decimal list-inside mt-1 space-y-0.5">');
            inList = true;
            listType = 'ordered';
          }
          const content = line.replace(/^\d+\.\s+/, '');
          result.push(`<li>${content}</li>`);
        }
        // Regular paragraph
        else {
          if (inList) {
            result.push(listType === 'ordered' ? '</ol>' : '</ul>');
            inList = false;
            listType = null;
          }
          if (line) {
            result.push(`<p class="mt-1">${line}</p>`);
          }
        }
      }
      
      // Close any open list
      if (inList) {
        result.push(listType === 'ordered' ? '</ol>' : '</ul>');
      }
      
      return result.join('');
    }

    function displayEventsByDate(workouts, running, health) {
      const container = document.getElementById('eventsByDate');
      const noEvents = document.getElementById('noEvents');
      
      container.innerHTML = '';
      
      // Combine all events with a type property for sorting/grouping
      // Filter out events without dates
      const allEvents = [
        ...workouts.map(w => ({ type: 'workout', date: w.session_date, data: w })),
        ...running.map(r => ({ type: 'running', date: r.session_date, data: r })),
        ...health.filter(h => h.date).map(h => ({ type: 'health', date: h.date, data: h }))
      ];

      if (allEvents.length === 0) {
        noEvents.classList.remove('hidden');
        return;
      }
      noEvents.classList.add('hidden');

      // Group by date
      const eventsByDate = {};
      allEvents.forEach(event => {
        if (!eventsByDate[event.date]) {
          eventsByDate[event.date] = [];
        }
        eventsByDate[event.date].push(event);
      });

      // Sort dates in descending order
      const sortedDates = Object.keys(eventsByDate).sort().reverse();

      sortedDates.forEach(date => {
        const dateSection = document.createElement('div');
        dateSection.className = 'border-b border-neutral-200 dark:border-neutral-700 pb-6';
        
        const dateHeader = document.createElement('h3');
        dateHeader.className = 'text-base font-semibold mb-4 flex items-center justify-between gap-2';
        const dateObj = new Date(date + 'T00:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        const titleDiv = document.createElement('div');
        titleDiv.className = 'flex items-center gap-2';
        titleDiv.innerHTML = `<span>üìÖ</span> ${dateStr}`;
        
        const summaryBtn = document.createElement('button');
        summaryBtn.className = 'px-3 py-1.5 rounded-lg bg-amber-600 hover:bg-amber-700 text-white text-xs font-medium transition-colors';
        summaryBtn.textContent = '‚ú® Summary';
        summaryBtn.onclick = () => generateDailySummaryForDate(date);
        
        dateHeader.appendChild(titleDiv);
        dateHeader.appendChild(summaryBtn);
        dateSection.appendChild(dateHeader);

        const eventsList = document.createElement('div');
        eventsList.className = 'space-y-3';

        eventsByDate[date].forEach(event => {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'p-4 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-900';
          
          let icon, content;
          
          if (event.type === 'workout') {
            icon = 'üí™';
            const exercises = event.data.exercises || [];
            const exerciseList = exercises.length > 0 
              ? `<div class="mt-3 space-y-2 text-xs border-t border-neutral-200 dark:border-neutral-700 pt-3">
                   ${exercises.map(ex => `
                     <div class="flex justify-between">
                       <span>${ex.exercise}</span>
                       <span class="text-neutral-600 dark:text-neutral-400">${ex.sets}√ó${ex.reps_per_set}${ex.weight_lbs ? ` @ ${ex.weight_lbs}lbs` : ''}</span>
                     </div>
                   `).join('')}
                 </div>`
              : '<p class="text-xs text-neutral-500 dark:text-neutral-500 mt-2">No exercise details</p>';
            content = `
              <p class="font-medium">${icon} Workout</p>
              <p class="text-xs text-neutral-500 dark:text-neutral-500 mt-1">${event.data.day_of_week || ''}</p>
              ${exerciseList}
            `;
          } else if (event.type === 'running') {
            const distance = event.data.distance_miles ? (event.data.distance_miles * 1.60934).toFixed(2) : 0;
            icon = 'üèÉ';
            content = `
              <p class="font-medium">${icon} Running</p>
              <div class="grid grid-cols-3 gap-3 mt-2 text-xs">
                <div><span class="text-neutral-600 dark:text-neutral-400">Distance:</span> <span class="font-medium text-emerald-600 dark:text-emerald-400">${distance} km</span></div>
                <div><span class="text-neutral-600 dark:text-neutral-400">Duration:</span> <span class="font-medium text-blue-600 dark:text-blue-400">${event.data.duration_minutes || 0} min</span></div>
                <div><span class="text-neutral-600 dark:text-neutral-400">Pace:</span> <span class="font-medium text-orange-600 dark:text-orange-400">${event.data.pace_min_per_mile || 'N/A'}</span></div>
              </div>
            `;
          } else if (event.type === 'health') {
            icon = '‚ù§Ô∏è';
            content = `
              <p class="font-medium">${icon} ${event.data.category || 'Health Event'}</p>
              <div class="grid grid-cols-3 gap-3 mt-2 text-xs">
                <div><span class="text-neutral-600 dark:text-neutral-400">Intensity:</span> <span class="font-medium">${event.data.intensity || 'N/A'}/10</span></div>
                <div><span class="text-neutral-600 dark:text-neutral-400">Duration:</span> <span class="font-medium">${event.data.duration_minutes || 0} min</span></div>
                ${event.data.notes ? `<div><span class="text-neutral-600 dark:text-neutral-400">Notes:</span> <span class="font-medium">${event.data.notes}</span></div>` : ''}
              </div>
            `;
          }
          
          eventDiv.innerHTML = content;
          eventsList.appendChild(eventDiv);
        });

        dateSection.appendChild(eventsList);

        // Add stored daily summary section below workouts/running
        const summaryContainer = document.createElement('div');
        summaryContainer.className = 'mt-6 border-t border-neutral-200 dark:border-neutral-700 pt-4';
        
        const summaryHeader = document.createElement('div');
        summaryHeader.className = 'flex items-center justify-between cursor-pointer hover:bg-neutral-100 dark:hover:bg-neutral-700/50 rounded-lg p-3 transition-colors';
        
        const summaryTitle = document.createElement('h4');
        summaryTitle.className = 'font-semibold flex items-center gap-2';
        summaryTitle.innerHTML = '<span>üìã</span> Daily Summary';
        
        const summaryToggle = document.createElement('span');
        summaryToggle.className = 'text-lg transition-transform duration-200';
        summaryToggle.textContent = '‚ñº';
        summaryToggle.dataset.expanded = 'true';
        
        summaryHeader.appendChild(summaryTitle);
        summaryHeader.appendChild(summaryToggle);
        
        const summaryContent = document.createElement('div');
        summaryContent.className = 'bg-indigo-50 dark:bg-indigo-900/20 rounded-lg p-4 mt-2 text-sm space-y-3 border border-indigo-200 dark:border-indigo-800';
        summaryContent.id = `summary-${date}`;
        
        // Load and display summary for this date
        loadDailySummary(date, summaryContent);
        
        summaryHeader.onclick = () => {
          const isExpanded = summaryToggle.dataset.expanded === 'true';
          summaryContent.classList.toggle('hidden', isExpanded);
          summaryToggle.dataset.expanded = !isExpanded;
          summaryToggle.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
        };
        
        summaryContainer.appendChild(summaryHeader);
        summaryContainer.appendChild(summaryContent);
        dateSection.appendChild(summaryContainer);

        container.appendChild(dateSection);
      });
    }

    function displayWorkouts(workouts) {
      // This function is no longer used but kept as fallback
    }

    function displayRunning(sessions) {
      // This function is no longer used but kept as fallback
    }

    function displayHealth(events) {
      // This function is no longer used but kept as fallback
    }

    function displayNutritionSummary(nutrition) {
      const container = document.getElementById('nutritionSummary');
      container.innerHTML = '';
      
      if (nutrition && nutrition.totals) {
        const { total_calories_kcal, total_protein_g, total_fiber_g, total_sodium_mg, days_logged } = nutrition.totals;
        const items = [
          { value: `${Math.round(total_calories_kcal)} kcal`, icon: 'üî•', title: 'Calories' },
          { value: `${Math.round(total_protein_g)}g`, icon: 'ü•ö', title: 'Protein' },
          { value: `${Math.round(total_fiber_g)}g`, icon: 'üåæ', title: 'Fiber' },
          { value: `${Math.round(total_sodium_mg)}mg`, icon: 'üßÇ', title: 'Sodium' },
          { value: `${days_logged}`, icon: 'üìÖ', title: 'Days' }
        ];
        
        items.forEach(item => {
          const div = document.createElement('div');
          div.className = 'bg-neutral-50 dark:bg-neutral-900 rounded p-4 flex flex-col items-center';
          div.title = item.title;
          div.innerHTML = `
            <div class="text-3xl mb-2">${item.icon}</div>
            <div class="text-lg font-bold text-indigo-600 dark:text-indigo-400">${item.value}</div>
          `;
          container.appendChild(div);
        });
        
        // Create nutrition chart
        renderNutritionChartHistory(nutrition.daily);
      } else {
        container.innerHTML = '<p class="text-sm text-neutral-600 dark:text-neutral-400">No nutrition data recorded</p>';
      }
    }

    function renderNutritionChartHistory(dailyData) {
      const ctx = document.getElementById('nutritionChartHistory');
      if (!ctx) {
        console.error('[History] nutritionChartHistory canvas not found');
        return;
      }

      if (!dailyData || dailyData.length === 0) {
        console.warn('[History] No daily data to chart');
        return;
      }

      // Destroy existing chart if it exists and is a valid Chart instance
      if (window.nutritionChartHistory && typeof window.nutritionChartHistory.destroy === 'function') {
        window.nutritionChartHistory.destroy();
      }

      // Filter and prepare data
      const data = dailyData.filter(d => d.date_local).map(d => ({
        date: d.date_local,
        calories: d.calories_kcal || 0,
        protein: d.protein_g || 0,
        fiber: d.fiber_g || 0,
        sodium: (d.sodium_mg || 0) / 10
      }));

      console.log('[History] Chart data prepared:', data);

      const labels = data.map(d => {
        const date = new Date(d.date);
        return `${date.getMonth() + 1}/${date.getDate()}`;
      });

      window.nutritionChartHistory = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Calories (kcal)',
              data: data.map(d => d.calories),
              backgroundColor: '#ef4444',
              borderColor: '#dc2626',
              borderWidth: 1
            },
            {
              label: 'Protein (g)',
              data: data.map(d => d.protein),
              backgroundColor: '#f97316',
              borderColor: '#ea580c',
              borderWidth: 1
            },
            {
              label: 'Fiber (g)',
              data: data.map(d => d.fiber),
              backgroundColor: '#22c55e',
              borderColor: '#16a34a',
              borderWidth: 1
            },
            {
              label: 'Sodium (mg √∑10)',
              data: data.map(d => d.sodium),
              backgroundColor: '#06b6d4',
              borderColor: '#0891b2',
              borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom',
              labels: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#a3a3a3' : '#404040',
                font: { size: 12 },
                padding: 12
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              grid: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#404040' : '#e5e5e5'
              },
              ticks: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#a3a3a3' : '#666'
              }
            },
            y: {
              stacked: false,
              beginAtZero: true,
              grid: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#404040' : '#e5e5e5'
              },
              ticks: {
                color: window.matchMedia('(prefers-color-scheme: dark)').matches ? '#a3a3a3' : '#666'
              }
            }
          }
        }
      });
    }
  </script>

  <!-- Daily Summary Modal -->
  <div id="summaryModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
    <div class="bg-white dark:bg-neutral-800 rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-neutral-200 dark:border-neutral-700 sticky top-0 bg-white dark:bg-neutral-800">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold flex items-center gap-2">
            <span>‚ú®</span> Daily Summary
          </h2>
          <button id="closeSummaryModalBtn" class="text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 text-2xl leading-none">√ó</button>
        </div>
        <p id="summaryDateLabel" class="text-sm text-neutral-600 dark:text-neutral-400 mt-1"></p>
      </div>

      <div id="summaryModalContent" class="p-6">
        <div id="summaryModalLoading" class="text-center py-8">
          <div class="inline-block animate-spin text-3xl">‚è≥</div>
          <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-3">Generating your daily summary...</p>
        </div>
        <div id="summaryModalError" class="hidden text-rose-600 dark:text-rose-400 text-sm p-4 rounded bg-rose-50 dark:bg-rose-900/10"></div>
        <div id="summaryModalText" class="hidden prose dark:prose-invert max-w-none text-sm"></div>
      </div>

      <div id="summaryModalFooter" class="hidden p-6 border-t border-neutral-200 dark:border-neutral-700 flex gap-2 bg-neutral-50 dark:bg-neutral-900">
        <button id="copySummaryModalBtn" class="flex-1 px-4 py-2 rounded-lg border border-amber-300 dark:border-amber-700 hover:bg-amber-50 dark:hover:bg-amber-900/20 text-sm font-medium transition-colors">
          üìã Copy
        </button>
        <button id="closeModalBtn" class="flex-1 px-4 py-2 rounded-lg bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-sm font-medium transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <script src="/js/history.js"></script>
  <script src="/js/dailySummary.js"></script>
