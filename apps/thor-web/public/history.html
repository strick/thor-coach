<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>History Dashboard â€” Thor</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Custom styles -->
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 min-h-screen">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="bg-white dark:bg-neutral-800 border-b border-neutral-200 dark:border-neutral-700">
      <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">ğŸ“– History Dashboard</h1>
          <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">View your complete activity log</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="cfgPill" class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400">Connected</span>
        </div>
      </div>

      <!-- Tab Navigation -->
      <nav class="px-4 sm:px-6">
        <div class="flex gap-1 border-b border-neutral-200 dark:border-neutral-700">
          <a href="/index.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            ğŸ  Home
          </a>
          <a href="/nutrition.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            ğŸ Nutrition
          </a>
          <a href="/running.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            ğŸƒ Running
          </a>
          <a href="/health.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            â¤ï¸ Health
          </a>
          <span class="px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 dark:text-indigo-400">
            ğŸ“– History
          </span>
          <a href="/progress.html" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors">
            ğŸ“Š Progress
          </a>
        </div>
      </nav>
    </header>

    <!-- Main Content -->
    <main class="p-4 sm:p-6">
      <!-- Date Range Filter -->
      <div class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6 mb-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>ğŸ—“ï¸</span> Filter by Date Range
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">From</label>
            <input type="date" id="dateFrom" class="w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">To</label>
            <input type="date" id="dateTo" class="w-full rounded-lg border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          </div>
          <div class="flex items-end gap-2">
            <button id="filterBtn" class="flex-1 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 font-medium text-sm transition-colors">
              Filter
            </button>
            <button id="clearFilterBtn" class="rounded-lg border border-neutral-300 dark:border-neutral-700 hover:bg-neutral-100 dark:hover:bg-neutral-700 transition-colors px-4 py-2.5 text-sm font-medium">
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Events by Date -->
      <section class="bg-white dark:bg-neutral-800 rounded-xl shadow-sm border border-neutral-200 dark:border-neutral-700 p-6">
        <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
          <span>ğŸ“…</span> All Events
        </h2>
        <div id="eventsByDate" class="space-y-6"></div>
        <div id="noEvents" class="text-sm text-neutral-600 dark:text-neutral-400 text-center py-4">No events found</div>
      </section>
    </main>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000';

    // Initialize date inputs to last 30 days
    window.addEventListener('load', () => {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;
      document.getElementById('dateTo').valueAsDate = today;
      
      loadHistoryData();
    });

    document.getElementById('filterBtn').addEventListener('click', loadHistoryData);
    document.getElementById('clearFilterBtn').addEventListener('click', () => {
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
      
      document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;
      document.getElementById('dateTo').valueAsDate = today;
      loadHistoryData();
    });

    async function loadHistoryData() {
      const from = document.getElementById('dateFrom').value;
      const to = document.getElementById('dateTo').value;

      try {
        // Load all data in parallel
        const [workoutsRes, runningRes, healthRes] = await Promise.all([
          fetch(`${API_BASE}/api/workouts?from=${from}&to=${to}`).then(r => r.json()).catch(() => ({ sessions: [] })),
          fetch(`${API_BASE}/api/running/sessions?from=${from}&to=${to}`).then(r => r.json()).catch(() => ({ sessions: [] })),
          fetch(`${API_BASE}/api/health-events?from=${from}&to=${to}`).then(r => r.json()).catch(() => ({ events: [] }))
        ]);

        displayEventsByDate(
          workoutsRes.sessions || [],
          runningRes.sessions || [],
          healthRes.events || []
        );
      } catch (error) {
        console.error('Error loading history:', error);
      }
    }

    function displayEventsByDate(workouts, running, health) {
      const container = document.getElementById('eventsByDate');
      const noEvents = document.getElementById('noEvents');
      
      container.innerHTML = '';
      
      // Combine all events with a type property for sorting/grouping
      const allEvents = [
        ...workouts.map(w => ({ type: 'workout', date: w.session_date, data: w })),
        ...running.map(r => ({ type: 'running', date: r.session_date, data: r })),
        ...health.map(h => ({ type: 'health', date: h.event_date, data: h }))
      ];

      if (allEvents.length === 0) {
        noEvents.classList.remove('hidden');
        return;
      }
      noEvents.classList.add('hidden');

      // Group by date
      const eventsByDate = {};
      allEvents.forEach(event => {
        if (!eventsByDate[event.date]) {
          eventsByDate[event.date] = [];
        }
        eventsByDate[event.date].push(event);
      });

      // Sort dates in descending order
      const sortedDates = Object.keys(eventsByDate).sort().reverse();

      sortedDates.forEach(date => {
        const dateSection = document.createElement('div');
        dateSection.className = 'border-b border-neutral-200 dark:border-neutral-700 pb-6';
        
        const dateHeader = document.createElement('h3');
        dateHeader.className = 'text-base font-semibold mb-4 flex items-center gap-2';
        const dateObj = new Date(date + 'T00:00:00');
        const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        dateHeader.innerHTML = `<span>ğŸ“…</span> ${dateStr}`;
        dateSection.appendChild(dateHeader);

        const eventsList = document.createElement('div');
        eventsList.className = 'space-y-3';

        eventsByDate[date].forEach(event => {
          const eventDiv = document.createElement('div');
          eventDiv.className = 'p-4 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-900';
          
          let icon, content;
          
          if (event.type === 'workout') {
            icon = 'ğŸ’ª';
            content = `
              <p class="font-medium">${icon} Workout</p>
              <p class="text-xs text-neutral-500 dark:text-neutral-500 mt-1">${event.data.day_of_week || ''}</p>
            `;
          } else if (event.type === 'running') {
            const distance = event.data.distance_miles ? (event.data.distance_miles * 1.60934).toFixed(2) : 0;
            icon = 'ğŸƒ';
            content = `
              <p class="font-medium">${icon} Running</p>
              <div class="grid grid-cols-3 gap-3 mt-2 text-xs">
                <div><span class="text-neutral-600 dark:text-neutral-400">Distance:</span> <span class="font-medium text-emerald-600 dark:text-emerald-400">${distance} km</span></div>
                <div><span class="text-neutral-600 dark:text-neutral-400">Duration:</span> <span class="font-medium text-blue-600 dark:text-blue-400">${event.data.duration_minutes || 0} min</span></div>
                <div><span class="text-neutral-600 dark:text-neutral-400">Pace:</span> <span class="font-medium text-orange-600 dark:text-orange-400">${event.data.pace_min_per_mile || 'N/A'}</span></div>
              </div>
            `;
          } else if (event.type === 'health') {
            icon = 'â¤ï¸';
            content = `
              <p class="font-medium">${icon} ${event.data.category || 'Health Event'}</p>
              <div class="grid grid-cols-3 gap-3 mt-2 text-xs">
                <div><span class="text-neutral-600 dark:text-neutral-400">Intensity:</span> <span class="font-medium">${event.data.intensity || 'N/A'}/10</span></div>
                <div><span class="text-neutral-600 dark:text-neutral-400">Duration:</span> <span class="font-medium">${event.data.duration_minutes || 0} min</span></div>
                ${event.data.notes ? `<div><span class="text-neutral-600 dark:text-neutral-400">Notes:</span> <span class="font-medium">${event.data.notes}</span></div>` : ''}
              </div>
            `;
          }
          
          eventDiv.innerHTML = content;
          eventsList.appendChild(eventDiv);
        });

        dateSection.appendChild(eventsList);
        container.appendChild(dateSection);
      });
    }

    function displayWorkouts(workouts) {
      // This function is no longer used but kept as fallback
    }

    function displayRunning(sessions) {
      // This function is no longer used but kept as fallback
    }

    function displayHealth(events) {
      // This function is no longer used but kept as fallback
    }
  </script>
</body>
</html>
