<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Template Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body class="bg-neutral-50 dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 min-h-screen">
  <div class="max-w-6xl mx-auto">
    <!-- Header -->
    <header class="bg-white dark:bg-neutral-800 border-b border-neutral-200 dark:border-neutral-700">
      <div class="px-4 sm:px-6 py-4 flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold tracking-tight">ğŸ“‹ Meal Templates</h1>
          <p class="text-xs text-neutral-500 dark:text-neutral-400 mt-0.5">Reusable meal templates for quick entry</p>
        </div>
        <div class="flex items-center gap-3">
          <div class="flex items-center gap-2">
            <label class="text-sm font-medium text-neutral-600 dark:text-neutral-400">User:</label>
            <select id="userSelect" class="px-3 py-1.5 rounded-lg border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 text-sm font-medium">
              <option>Loading users...</option>
            </select>
            <button id="addUserBtn" class="px-3 py-1.5 rounded-lg bg-neutral-200 dark:bg-neutral-700 hover:bg-neutral-300 dark:hover:bg-neutral-600 text-sm font-medium transition-colors" title="Add new user">
              +
            </button>
          </div>
          <span id="cfgPill" class="text-xs px-2 py-1 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400">Connected</span>
        </div>
      </div>

      <!-- Tab Navigation -->
      <nav class="px-4 sm:px-6">
        <div class="flex gap-1 border-b border-neutral-200 dark:border-neutral-700">
          <a href="/index.html" class="nav-link px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors" data-tab="home">
            ğŸ  Home
          </a>
          <a href="/nutrition.html" class="nav-link px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors" data-tab="nutrition">
            ğŸ Nutrition
          </a>
          <a href="/running.html" class="nav-link px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors" data-tab="running">
            ğŸƒ Running
          </a>
          <a href="/health.html" class="nav-link px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors" data-tab="health">
            â¤ï¸ Health
          </a>
          <span class="px-4 py-3 text-sm font-medium border-b-2 border-indigo-600 text-indigo-600 dark:text-indigo-400">
            ğŸ“‹ Templates
          </span>
          <a href="/history.html" class="nav-link px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors" data-tab="history">
            ğŸ“– History
          </a>
          <a href="/progress.html" class="nav-link px-4 py-3 text-sm font-medium border-b-2 border-transparent text-neutral-600 dark:text-neutral-400 hover:text-neutral-900 dark:hover:text-neutral-100 transition-colors" data-tab="progress">
            ğŸ“Š Progress
          </a>
        </div>
      </nav>
    </header>

    <main class="p-4 sm:p-6">
      <div class="mb-6 flex items-center justify-between">
        <div>
          <h2 class="text-xl font-semibold text-neutral-900 dark:text-neutral-100">Manage Your Templates</h2>
          <p class="text-sm text-neutral-600 dark:text-neutral-400 mt-1">Save and reuse your favorite meals</p>
        </div>
        <a id="backToNutrition" href="/nutrition.html" class="px-4 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-medium transition-colors">
          â† Back to Nutrition
        </a>
      </div>

    <!-- Loading State -->
    <div id="loadingState" class="text-center py-8">
      <p class="text-neutral-600 dark:text-neutral-400">Loading templates...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-16 bg-neutral-50 dark:bg-neutral-900/50 rounded-lg border border-neutral-200 dark:border-neutral-800">
      <p class="text-lg font-semibold mb-2">No templates yet</p>
      <p class="text-neutral-600 dark:text-neutral-400">Go to Nutrition and save a meal as a template to get started!</p>
      <a id="createTemplateLink" href="/nutrition.html" class="inline-block mt-4 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">Create Template</a>
    </div>

    <!-- Templates Grid -->
    <div id="templatesGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Templates will be inserted here -->
    </div>
  </main>

  <!-- Delete Confirmation Modal -->
  <div id="deleteModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-neutral-900 rounded-lg p-6 max-w-sm mx-4">
      <h3 class="text-lg font-bold mb-2">Delete Template?</h3>
      <p class="text-neutral-600 dark:text-neutral-400 mb-6">
        Are you sure you want to delete "<span id="deleteTemplateName"></span>"? This action cannot be undone.
      </p>
      <div class="flex gap-3">
        <button id="cancelDeleteBtn" class="flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-700 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors">
          Cancel
        </button>
        <button id="confirmDeleteBtn" class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Items Modal -->
  <div id="itemsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white dark:bg-neutral-900 rounded-lg p-6 max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h3 class="text-xl font-bold mb-1" id="itemsModalTitle">Template Items</h3>
          <p class="text-sm text-neutral-600 dark:text-neutral-400" id="itemsModalMealType"></p>
        </div>
        <button id="closeItemsModal" class="text-2xl hover:text-neutral-600 dark:hover:text-neutral-400">&times;</button>
      </div>
      <div id="itemsList" class="space-y-2">
        <!-- Items will be inserted here -->
      </div>
      <div class="mt-6 flex gap-3">
        <button id="closeItemsModalBtn" class="flex-1 px-4 py-2 border border-neutral-300 dark:border-neutral-700 rounded-lg hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors">
          Close
        </button>
        <button id="applyFromModalBtn" class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
          Apply Template
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3000/api';
    
    // Check if userId is provided in URL query parameter
    const urlParams = new URLSearchParams(window.location.search);
    const urlUserId = urlParams.get('userId');
    let currentUserId = urlUserId || localStorage.getItem('selectedUserId') || 'user-main';
    
    let templates = [];
    let selectedTemplateId = null;

    /**
     * Apply theme based on current user
     */
    function applyTheme() {
      const wifeUserId = '6365e445-593b-4c5f-8787-9c3afd6569f6';
      const isWife = currentUserId === wifeUserId;
      const html = document.documentElement;
      
      if (isWife) {
        // Light mode for ARELCI
        html.classList.remove('dark');
      } else {
        // Dark mode for main user
        html.classList.add('dark');
      }
    }

    /**
     * Update navigation visibility based on current user
     */
    function updateNavVisibility() {
      // Wife's user ID
      const wifeUserId = '6365e445-593b-4c5f-8787-9c3afd6569f6';
      const isWife = currentUserId === wifeUserId;
      
      // Get all nav links
      const navLinks = document.querySelectorAll('.nav-link');
      
      navLinks.forEach(link => {
        const tab = link.getAttribute('data-tab');
        // Show only nutrition and templates for wife, show all for main user
        if (isWife && tab !== 'templates' && tab !== 'nutrition') {
          link.style.display = 'none';
        } else {
          link.style.display = '';
        }
      });
    }

    /**
     * Load and populate users dropdown
     */
    async function loadUsers() {
      try {
        const response = await fetch(`${API_BASE}/users`);
        const data = await response.json();
        const users = data.users || data; // Handle both wrapped and unwrapped responses
        
        const userSelect = document.getElementById('userSelect');
        if (!userSelect) return;
        
        userSelect.innerHTML = '';
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.name;
          userSelect.appendChild(option);
        });
        
        // Set dropdown to current user (already set from URL or localStorage)
        userSelect.value = currentUserId;
        
        // Update nav visibility
        updateNavVisibility();
        
        // Update links to include userId
        const backLink = document.getElementById('backToNutrition');
        const createLink = document.getElementById('createTemplateLink');
        const userIdParam = `?userId=${encodeURIComponent(currentUserId)}`;
        if (backLink) backLink.href = `/nutrition.html${userIdParam}`;
        if (createLink) createLink.href = `/nutrition.html${userIdParam}`;
        
        // Load templates
        loadTemplates();
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    async function loadTemplates() {
      try {
        const response = await fetch(`${API_BASE}/nutrition/templates?userId=${encodeURIComponent(currentUserId)}`);
        const data = await response.json();
        templates = data.templates || [];

        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const templatesGrid = document.getElementById('templatesGrid');

        if (templates.length === 0) {
          loadingState.classList.add('hidden');
          emptyState.classList.remove('hidden');
          templatesGrid.classList.add('hidden');
          return;
        }

        loadingState.classList.add('hidden');
        emptyState.classList.add('hidden');
        templatesGrid.classList.remove('hidden');

        templatesGrid.innerHTML = templates
          .map(
            (template) => `
          <div class="bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 rounded-lg p-6 hover:shadow-lg transition-shadow">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="font-bold text-lg">${escapeHtml(template.name)}</h3>
                <p class="text-xs text-neutral-500 dark:text-neutral-400 capitalize">${template.meal_type || 'meal'}</p>
              </div>
              <div class="flex gap-2">
                <button 
                  class="p-2 text-neutral-500 hover:text-blue-600 dark:hover:text-blue-400 transition-colors"
                  title="View items"
                  onclick="showItemsModal('${template.id}')"
                >
                  ğŸ‘ï¸
                </button>
                <button 
                  class="p-2 text-neutral-500 hover:text-red-600 dark:hover:text-red-400 transition-colors"
                  title="Delete"
                  onclick="showDeleteModal('${template.id}', '${escapeHtml(template.name)}')"
                >
                  ğŸ—‘ï¸
                </button>
              </div>
            </div>

            <div class="bg-neutral-50 dark:bg-neutral-800/50 rounded p-3 mb-4">
              <p class="text-xs text-neutral-600 dark:text-neutral-400 mb-2">Items:</p>
              <div class="space-y-1">
                ${JSON.parse(template.items_json || '[]')
                  .slice(0, 3)
                  .map((item) => `<p class="text-sm">â€¢ ${escapeHtml(item.food_name)}</p>`)
                  .join('')}
                ${JSON.parse(template.items_json || '[]').length > 3 ? `<p class="text-xs text-neutral-500">+${JSON.parse(template.items_json || '[]').length - 3} more</p>` : ''}
              </div>
            </div>

            <div class="flex gap-2">
              <button
                class="flex-1 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors text-sm font-medium"
                onclick="applyTemplate('${template.id}')"
              >
                Apply
              </button>
            </div>

            <p class="text-xs text-neutral-400 dark:text-neutral-500 mt-3">
              ${new Date(template.created_at).toLocaleDateString()}
            </p>
          </div>
        `
          )
          .join('');
      } catch (error) {
        console.error('Error loading templates:', error);
        document.getElementById('loadingState').innerHTML =
          '<p class="text-red-600">Error loading templates</p>';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showDeleteModal(templateId, templateName) {
      selectedTemplateId = templateId;
      document.getElementById('deleteTemplateName').textContent = templateName;
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function hideDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
      selectedTemplateId = null;
    }

    async function confirmDelete() {
      if (!selectedTemplateId) return;

      try {
        const response = await fetch(
          `${API_BASE}/nutrition/template/${selectedTemplateId}`,
          { method: 'DELETE' }
        );

        if (response.ok) {
          hideDeleteModal();
          loadTemplates();
        } else {
          alert('Failed to delete template');
        }
      } catch (error) {
        console.error('Error deleting template:', error);
        alert('Error deleting template');
      }
    }

    function showItemsModal(templateId) {
      const template = templates.find((t) => t.id === templateId);
      if (!template) return;

      selectedTemplateId = templateId;
      const items = JSON.parse(template.items_json || '[]');

      document.getElementById('itemsModalTitle').textContent = template.name;
      document.getElementById('itemsModalMealType').textContent = `${template.meal_type || 'meal'} â€¢ ${items.length} item${items.length !== 1 ? 's' : ''}`;

      const itemsList = document.getElementById('itemsList');
      itemsList.innerHTML = items
        .map(
          (item) => `
        <div class="bg-neutral-50 dark:bg-neutral-800/50 rounded p-3 border border-neutral-200 dark:border-neutral-700">
          <div class="font-medium">${escapeHtml(item.food_name)}</div>
          <div class="text-xs text-neutral-600 dark:text-neutral-400 mt-1">
            ${item.calories_kcal ? `${item.calories_kcal} cal` : ''} 
            ${item.protein_g ? `â€¢ ${item.protein_g}g protein` : ''}
          </div>
        </div>
      `
        )
        .join('');

      document.getElementById('itemsModal').classList.remove('hidden');
    }

    function hideItemsModal() {
      document.getElementById('itemsModal').classList.add('hidden');
      selectedTemplateId = null;
    }

    async function applyTemplate(templateId) {
      // For now, redirect to nutrition page with template info
      // In a real app, we'd need to let them choose which meal to apply to
      alert('To apply this template, go to Nutrition page and open the Add Meal modal. The template will appear there!');
    }

    // Event Listeners
    const userSelect = document.getElementById('userSelect');
    const addUserBtn = document.getElementById('addUserBtn');
    
    if (userSelect) {
      userSelect.addEventListener('change', (e) => {
        currentUserId = e.target.value;
        localStorage.setItem('selectedUserId', currentUserId);
        applyTheme(); // Apply theme for new user
        updateNavVisibility(); // Update visible tabs
        loadTemplates(); // Reload data for new user
      });
    }
    
    if (addUserBtn) {
      addUserBtn.addEventListener('click', () => {
        const userName = prompt('Enter new user name:');
        if (!userName || userName.trim() === '') return;
        // For now, just show an alert. This would need API implementation
        alert('User creation not yet implemented on this page');
      });
    }

    document.getElementById('cancelDeleteBtn').addEventListener('click', hideDeleteModal);
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
    document.getElementById('closeItemsModal').addEventListener('click', hideItemsModal);
    document.getElementById('closeItemsModalBtn').addEventListener('click', hideItemsModal);
    document.getElementById('applyFromModalBtn').addEventListener('click', () => {
      hideItemsModal();
      alert('To apply this template, go to Nutrition page and open the Add Meal modal. The template will appear there!');
    });

    // Load users and initialize on page load
    loadUsers();
    applyTheme(); // Apply theme on page load
  </script>
    </div>
  </body>
</html>

```
