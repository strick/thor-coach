<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thor AI Chat ‚Äî Health Assistant</title>
  <!-- Tailwind (CDN for quick MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Custom styles -->
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 text-white min-h-screen">
  <div class="max-w-4xl mx-auto h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-black/30 backdrop-blur border-b border-purple-500/20">
      <div class="px-4 sm:px-6 py-4">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-3xl font-bold tracking-tight bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
              ü§ñ Thor AI
            </h1>
            <p class="text-xs text-purple-300/60 mt-0.5">Your personal health & fitness coach</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="modeBtn" class="px-3 py-1.5 rounded-lg bg-purple-600/20 hover:bg-purple-600/40 border border-purple-500/30 text-xs font-medium transition-colors">
              Mode: Auto
            </button>
            <button id="settingsBtn" class="p-2 rounded-lg hover:bg-purple-600/20 transition-colors" title="Settings">
              ‚öôÔ∏è
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Chat Container -->
    <main class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-4" id="chatContainer">
      <!-- Messages will be inserted here -->
      <div class="flex justify-center items-center h-full">
        <div class="text-center">
          <div class="text-6xl mb-4">ü§ñ</div>
          <h2 class="text-2xl font-bold mb-2">Welcome to Thor AI</h2>
          <p class="text-purple-300/60 max-w-sm">
            Your intelligent health & fitness coach. Ask me about your workouts, nutrition, health, or get an overview of your progress.
          </p>
          <div class="mt-6 text-sm text-purple-300/40 space-y-1">
            <p>üí™ "Log floor press 4x8 at 45"</p>
            <p>ü•ó "I had chicken for lunch"</p>
            <p>‚ù§Ô∏è "Had a migraine today"</p>
            <p>üìä "How am I doing?"</p>
          </div>
        </div>
      </div>
    </main>

    <!-- Terminal-Style History Area (always visible) -->
    <div id="statusArea" class="bg-black/60 border-t border-purple-500/20 px-4 sm:px-6 py-4 flex flex-col max-h-64">
      <div class="text-xs text-purple-400/80 font-mono mb-2 flex items-center gap-2 justify-between">
        <div class="flex items-center gap-2">
          <span>‚öôÔ∏è</span>
          <span>Terminal</span>
        </div>
        <div class="flex gap-2">
          <button id="clearTerminalBtn" class="text-xs px-2 py-1 rounded bg-purple-600/30 hover:bg-purple-600/50 transition-colors" title="Clear terminal history">Clear</button>
          <button id="toggleTerminalBtn" class="text-xs px-2 py-1 rounded bg-purple-600/30 hover:bg-purple-600/50 transition-colors" title="Hide terminal">Hide</button>
        </div>
      </div>
      <div id="terminalLog" class="flex-1 overflow-y-auto text-xs font-mono text-green-400/80 space-y-0.5 bg-black/80 rounded px-3 py-2 border border-purple-500/10">
        <div class="text-purple-400/60">‚ñ∂ Starting request...</div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="bg-black/30 backdrop-blur border-t border-purple-500/20 p-4 sm:p-6">
      <div class="flex gap-3">
        <div class="flex-1 relative">
          <input
            type="text"
            id="messageInput"
            class="w-full px-4 py-3 rounded-lg bg-slate-800 border border-purple-500/30 focus:border-purple-500 focus:outline-none text-white placeholder-purple-300/40 transition-colors"
            placeholder="Ask me anything... (or type your query)"
          />
          <button
            id="micBtn"
            class="absolute right-2 top-1/2 -translate-y-1/2 p-2 rounded-lg hover:bg-purple-600/20 transition-colors"
            title="Voice input"
          >
            üé§
          </button>
        </div>
        <button
          id="sendBtn"
          class="px-6 py-3 rounded-lg bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Send
        </button>
      </div>
      <p id="micStatus" class="text-xs text-purple-300/40 mt-2"></p>
    </div>
  </div>

  <!-- Mode Selector Modal -->
  <div id="modeModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center">
    <div class="bg-slate-800 rounded-2xl shadow-2xl max-w-md w-full mx-4 border border-purple-500/20">
      <div class="p-6">
        <h3 class="text-lg font-semibold mb-4">Select Mode</h3>
        <div class="space-y-2">
          <button class="mode-option w-full text-left px-4 py-3 rounded-lg bg-purple-600/20 hover:bg-purple-600/40 border border-purple-500/30 transition-colors" data-mode="auto">
            <div class="font-medium">Auto</div>
            <div class="text-xs text-purple-300/60">Automatically detect what you need</div>
          </button>
          <button class="mode-option w-full text-left px-4 py-3 rounded-lg hover:bg-purple-600/20 border border-transparent hover:border-purple-500/30 transition-colors" data-mode="thor">
            <div class="font-medium">üí™ Workouts</div>
            <div class="text-xs text-purple-300/60">Log exercises and track progress</div>
          </button>
          <button class="mode-option w-full text-left px-4 py-3 rounded-lg hover:bg-purple-600/20 border border-transparent hover:border-purple-500/30 transition-colors" data-mode="nutrition">
            <div class="font-medium">ü•ó Nutrition</div>
            <div class="text-xs text-purple-300/60">Track meals and macros</div>
          </button>
          <button class="mode-option w-full text-left px-4 py-3 rounded-lg hover:bg-purple-600/20 border border-transparent hover:border-purple-500/30 transition-colors" data-mode="health">
            <div class="font-medium">‚ù§Ô∏è Health</div>
            <div class="text-xs text-purple-300/60">Log symptoms and health events</div>
          </button>
          <button class="mode-option w-full text-left px-4 py-3 rounded-lg hover:bg-purple-600/20 border border-transparent hover:border-purple-500/30 transition-colors" data-mode="overview">
            <div class="font-medium">üìä Overview</div>
            <div class="text-xs text-purple-300/60">Get summary of your progress</div>
          </button>
        </div>
        <button id="modeCloseBtn" class="mt-4 w-full px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 transition-colors">
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <script>
    // Use current hostname so it works from any device (localhost or LAN IP)
    const META_RUNNER_URL = `http://${window.location.hostname}:3004`;
    const chatContainer = document.getElementById('chatContainer');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const modeBtn = document.getElementById('modeBtn');
    const modeModal = document.getElementById('modeModal');
    const micBtn = document.getElementById('micBtn');
    const micStatus = document.getElementById('micStatus');
    const toastContainer = document.getElementById('toastContainer');
    const statusArea = document.getElementById('statusArea');
    const terminalLog = document.getElementById('terminalLog');
    const clearTerminalBtn = document.getElementById('clearTerminalBtn');
    const toggleTerminalBtn = document.getElementById('toggleTerminalBtn');

    let currentMode = 'auto';
    let isLoading = false;
    let terminalHidden = false;
    let activeRequest = null;

    // Ensure terminal is always visible on load
    statusArea.classList.remove('hidden');
    statusArea.style.display = 'flex';

    // Clear terminal history
    clearTerminalBtn.addEventListener('click', () => {
      terminalLog.innerHTML = '<div class="text-purple-400/60">‚ñ∂ Terminal cleared</div>';
    });

    // Toggle terminal visibility
    toggleTerminalBtn.addEventListener('click', () => {
      terminalHidden = !terminalHidden;
      if (terminalHidden) {
        statusArea.classList.add('hidden');
        toggleTerminalBtn.textContent = 'Show';
      } else {
        statusArea.classList.remove('hidden');
        statusArea.style.display = 'flex';
        toggleTerminalBtn.textContent = 'Hide';
      }
    });

    // Terminal-style logging
    function addTerminalLine(text, type = 'normal') {
      const line = document.createElement('div');
      const timestamp = new Date().toLocaleTimeString();
      
      if (type === 'command') {
        line.textContent = `$ ${text}`;
        line.className = 'text-cyan-400/80';
      } else if (type === 'success') {
        line.textContent = `‚úì ${text}`;
        line.className = 'text-green-400/80';
      } else if (type === 'info') {
        line.textContent = `‚Üí ${text}`;
        line.className = 'text-blue-400/80';
      } else if (type === 'agent') {
        line.textContent = `ü§ñ [${timestamp}] ${text}`;
        line.className = 'text-purple-400/80 font-semibold';
      } else if (type === 'error') {
        line.textContent = `‚úó ERROR: ${text}`;
        line.className = 'text-red-400/80';
      } else {
        line.textContent = `[${timestamp}] ${text}`;
        line.className = 'text-green-400/80';
      }
      
      terminalLog.appendChild(line);
      terminalLog.scrollTop = terminalLog.scrollHeight;
    }

    // Show status updates
    function showStatus(message) {
      // Terminal is always visible now
    }

    // Initialize chat
    function initChat() {
      messageInput.focus();
    }

    // Helper to delay for status visibility
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Send message using SSE
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || isLoading || activeRequest) return;

      isLoading = true;
      sendBtn.disabled = true;

      // Show user message
      addMessage(text, 'user');
      messageInput.value = '';

      try {
        // Add separator in terminal
        const separator = document.createElement('div');
        separator.className = 'text-purple-500/40 my-1';
        separator.textContent = '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ';
        terminalLog.appendChild(separator);

        // Log to terminal
        addTerminalLine(`Sending query: "${text}"`, 'command');
        showStatus('Processing...');

        // Build SSE URL with query params
        const params = new URLSearchParams({
          text,
          ...(currentMode !== 'auto' && { mode: currentMode })
        });
        const sseUrl = `${META_RUNNER_URL}/chat/stream?${params.toString()}`;

        // Open SSE connection
        const eventSource = new EventSource(sseUrl);
        activeRequest = eventSource;

        eventSource.addEventListener('message', (event) => {
          try {
            const parsed = JSON.parse(event.data);

            if (parsed.type === 'status') {
              // Log history entries from server
              if (parsed.history && parsed.history.length > 0) {
                // Get the latest entry
                const latestEntry = parsed.history[parsed.history.length - 1];
                
                // Determine log type based on step
                let logType = 'info';
                if (latestEntry.step === 'Received') logType = 'command';
                else if (latestEntry.step === 'Agent') logType = 'agent';
                else if (latestEntry.step === 'Complete') logType = 'success';
                
                addTerminalLine(`${latestEntry.step}: ${latestEntry.detail}`, logType);
              }
            } else if (parsed.type === 'progress') {
              // Show progress bar during agent execution
              addTerminalLine(parsed.message, 'info');
            } else if (parsed.type === 'response') {
              // Final response received
              const data = parsed.data;
              
              const modelInfo = data.model && data.provider ? ` | Model: ${data.provider}/${data.model}` : '';
              addTerminalLine(`Agent: ${data.agent.toUpperCase()} | Intent: ${data.intent}${modelInfo}`, 'agent');
              if (data.actions && data.actions.length > 0) {
                addTerminalLine(`Actions: ${data.actions.join(', ')}`, 'success');
              }
              addTerminalLine('‚úì Request completed successfully', 'success');
              
              // Show agent response
              addMessage(data.message, 'assistant', {
                agent: data.agent,
                intent: data.intent,
                actions: data.actions
              });

              // Show actions as info
              if (data.actions && data.actions.length > 0) {
                const actionsText = `Actions: ${data.actions.join(', ')}`;
                addMessage(actionsText, 'info');
              }

              activeRequest = null;
              eventSource.close();
            } else if (parsed.type === 'error') {
              addTerminalLine(parsed.message, 'error');
              addMessage(`Error: ${parsed.message}`, 'error');
              showToast(`Failed: ${parsed.message}`, 'error');
              activeRequest = null;
              eventSource.close();
            }
          } catch (err) {
            console.error('Failed to parse SSE event:', err);
          }
        });

        eventSource.addEventListener('error', (error) => {
          addTerminalLine('Connection error during request', 'error');
          console.error('SSE error:', error);
          addMessage('Connection error while processing request', 'error');
          showToast('Connection error', 'error');
          activeRequest = null;
          eventSource.close();
        });
      } catch (error) {
        addTerminalLine(error.message, 'error');
        addMessage(`Error: ${error.message}`, 'error');
        showToast(`Failed to send message: ${error.message}`, 'error');
      } finally {
        isLoading = false;
        activeRequest = null;
        sendBtn.disabled = false;
        messageInput.focus();
      }
    }

    // Format message text (convert bullets to HTML lists)
    function formatMessage(text) {
      // Escape HTML to prevent XSS
      const escapeHtml = (str) => {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      };

      const lines = text.split('\n');
      let formatted = [];
      let inList = false;
      let listItems = [];

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmed = line.trim();

        // Check if line starts with bullet (‚Ä¢ or -)
        if (trimmed.startsWith('‚Ä¢') || trimmed.startsWith('-')) {
          const content = trimmed.substring(1).trim();
          listItems.push(`<li>${escapeHtml(content)}</li>`);
          inList = true;
        } else {
          // Not a bullet line
          if (inList && listItems.length > 0) {
            // Close the list
            formatted.push(`<ul class="list-disc list-inside space-y-1 my-2">${listItems.join('')}</ul>`);
            listItems = [];
            inList = false;
          }

          if (trimmed) {
            formatted.push(escapeHtml(line));
          } else {
            formatted.push('<br>');
          }
        }
      }

      // Close any remaining list
      if (inList && listItems.length > 0) {
        formatted.push(`<ul class="list-disc list-inside space-y-1 my-2">${listItems.join('')}</ul>`);
      }

      return formatted.join('');
    }

    // Add message to chat
    function addMessage(text, role, metadata = {}) {
      if (chatContainer.querySelector('.flex.justify-center')) {
        chatContainer.innerHTML = '';
      }

      const messageDiv = document.createElement('div');
      messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

      let bgClass, textClass;
      if (role === 'user') {
        bgClass = 'bg-purple-600';
        textClass = 'text-white';
      } else if (role === 'error') {
        bgClass = 'bg-red-600/20 border border-red-500/30';
        textClass = 'text-red-200';
      } else if (role === 'info') {
        bgClass = 'bg-slate-700/50 border border-slate-600/30';
        textClass = 'text-slate-300';
      } else {
        bgClass = 'bg-slate-800 border border-purple-500/20';
        textClass = 'text-white';
      }

      const content = document.createElement('div');
      content.className = `max-w-2xl px-4 py-3 rounded-lg ${bgClass} ${textClass} text-sm`;

      let html = formatMessage(text);
      if (metadata.agent) {
        const modelInfo = metadata.model && metadata.provider ? ` | Model: ${metadata.provider}/${metadata.model}` : '';
        html += `<div class="text-xs opacity-70 mt-2">Agent: ${metadata.agent} | Intent: ${metadata.intent}${modelInfo}</div>`;
      }
      content.innerHTML = html;

      messageDiv.appendChild(content);
      chatContainer.appendChild(messageDiv);

      // Scroll to bottom
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Show toast notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `px-4 py-3 rounded-lg text-sm font-medium ${
        type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-emerald-600' : 'bg-purple-600'
      }`;
      toast.textContent = message;
      toastContainer.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Mode selector
    modeBtn.addEventListener('click', () => {
      modeModal.classList.remove('hidden');
      modeModal.classList.add('flex');
    });

    document.getElementById('modeCloseBtn').addEventListener('click', () => {
      modeModal.classList.add('hidden');
      modeModal.classList.remove('flex');
    });

    document.querySelectorAll('.mode-option').forEach(btn => {
      btn.addEventListener('click', () => {
        currentMode = btn.dataset.mode;
        const modeLabel = {
          'auto': 'Auto',
          'thor': 'üí™ Workouts',
          'nutrition': 'ü•ó Nutrition',
          'health': '‚ù§Ô∏è Health',
          'overview': 'üìä Overview'
        }[currentMode];
        modeBtn.textContent = `Mode: ${modeLabel}`;
        modeModal.classList.add('hidden');
        modeModal.classList.remove('flex');
      });
    });

    // Voice input (placeholder - would need speech recognition API)
    micBtn.addEventListener('click', () => {
      showToast('Voice input coming soon!');
    });

    initChat();
  </script>
</body>
</html>
